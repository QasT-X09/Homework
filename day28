import 'dart:io';
import 'package:dio/dio.dart';
import 'package:flutter/material.dart';
import 'package:path_provider/path_provider.dart';

void main() {
  runApp(const MyApp());
}

/// ======================
///  DIO CLIENT
/// ======================
class DioClient {
  static final DioClient _instance = DioClient._internal();
  factory DioClient() => _instance;

  late final Dio dio;

  DioClient._internal() {
    dio = Dio(
      BaseOptions(
        baseUrl: 'https://jsonplaceholder.typicode.com',
        connectTimeout: const Duration(seconds: 5),
        receiveTimeout: const Duration(seconds: 5),
        sendTimeout: const Duration(seconds: 5),
      ),
    );

    dio.interceptors.add(
      InterceptorsWrapper(
        onRequest: (options, handler) {
          debugPrint('‚û°Ô∏è REQUEST: ${options.method} ${options.uri}');
          return handler.next(options);
        },
        onResponse: (response, handler) {
          debugPrint('‚úÖ RESPONSE: ${response.statusCode}');
          return handler.next(response);
        },
        onError: (error, handler) async {
          debugPrint('‚ùå ERROR: ${error.message}');

          // Retry —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
          if (_shouldRetry(error)) {
            try {
              debugPrint('üîÅ RETRYING...');
              final cloneReq = await dio.request(
                error.requestOptions.path,
                data: error.requestOptions.data,
                queryParameters: error.requestOptions.queryParameters,
                options: Options(
                  method: error.requestOptions.method,
                ),
              );
              return handler.resolve(cloneReq);
            } catch (_) {}
          }

          return handler.next(error);
        },
      ),
    );
  }

  bool _shouldRetry(DioException error) {
    return error.type == DioExceptionType.connectionTimeout ||
        error.type == DioExceptionType.receiveTimeout ||
        error.type == DioExceptionType.unknown;
  }
}

/// ======================
///  APP
/// ======================
class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return const MaterialApp(
      home: HomePage(),
    );
  }
}

class HomePage extends StatefulWidget {
  const HomePage({super.key});

  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  final Dio dio = DioClient().dio;
  final CancelToken cancelToken = CancelToken();

  bool isLoading = false;
  double progress = 0;
  String result = '';

  @override
  void dispose() {
    cancelToken.cancel("Page disposed");
    super.dispose();
  }

  Future<void> fetchData() async {
    setState(() {
      isLoading = true;
      result = '';
    });

    try {
      final response = await dio.get(
        '/posts/1',
        cancelToken: cancelToken,
      );

      setState(() {
        result = response.data.toString();
      });
    } on DioException catch (e) {
      setState(() {
        result = _handleError(e);
      });
    } finally {
      setState(() {
        isLoading = false;
      });
    }
  }

  Future<void> downloadFile() async {
    setState(() {
      isLoading = true;
      progress = 0;
    });

    try {
      final dir = await getApplicationDocumentsDirectory();
      final filePath = '${dir.path}/image.jpg';

      await dio.download(
        'https://picsum.photos/600',
        filePath,
        cancelToken: cancelToken,
        onReceiveProgress: (received, total) {
          if (total != -1) {
            setState(() {
              progress = received / total;
            });
          }
        },
      );

      setState(() {
        result = "–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: $filePath";
      });
    } on DioException catch (e) {
      setState(() {
        result = _handleError(e);
      });
    } finally {
      setState(() {
        isLoading = false;
      });
    }
  }

  String _handleError(DioException e) {
    if (CancelToken.isCancel(e)) {
      return "–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω—ë–Ω";
    }

    if (e.type == DioExceptionType.connectionTimeout ||
        e.type == DioExceptionType.unknown) {
      return "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É";
    }

    final statusCode = e.response?.statusCode;

    switch (statusCode) {
      case 400:
        return "–û—à–∏–±–∫–∞ 400: –ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å";
      case 401:
        return "–û—à–∏–±–∫–∞ 401: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
      case 500:
        return "–û—à–∏–±–∫–∞ 500: –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
      default:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Dio Example")),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            ElevatedButton(
              onPressed: fetchData,
              child: const Text("GET –∑–∞–ø—Ä–æ—Å"),
            ),
            ElevatedButton(
              onPressed: downloadFile,
              child: const Text("–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"),
            ),
            if (isLoading) ...[
              const SizedBox(height: 20),
              const CircularProgressIndicator(),
              if (progress > 0)
                Padding(
                  padding: const EdgeInsets.only(top: 10),
                  child: Text("${(progress * 100).toStringAsFixed(0)}%"),
                ),
            ],
            const SizedBox(height: 20),
            Expanded(
              child: SingleChildScrollView(
                child: Text(result),
              ),
            ),
          ],
        ),
      ),
    );
  }
}